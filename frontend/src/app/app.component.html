<div class="main-layout">

    <!-- HEADER -->
    <header class="top-bar">
        <!-- GAUCHE -->
        <div class="flex items-center gap-3">
            <button pButton icon="pi pi-align-left" [text]="true" [rounded]="true" (click)="toggleLeftPanel()"
                pTooltip="Historique" tooltipPosition="bottom" [class.text-neuclid-accent]="panelSizes()[0] > 0"
                class="text-gray-400 hover:text-white transition-colors">
            </button>
            <div class="logo">üìê Neuclid <span class="badge">v2.0</span></div>
        </div>
    
        <!-- DROITE -->
        <div class="flex items-center gap-3">
            <button pButton icon="pi pi-align-right" [text]="true" [rounded]="true" (click)="toggleRightPanel()"
                pTooltip="Inspecteur" tooltipPosition="bottom" [class.text-neuclid-accent]="panelSizes()[2] > 0"
                class="text-gray-400 hover:text-white transition-colors">
            </button>
        </div>
    </header>

    <!-- WORKSPACE -->
    <div class="workspace">
        <!-- ICI : On lie [panelSizes] au signal panelSizes() -->
        <p-splitter [style]="{'height': '100%'}" [panelSizes]="panelSizes()" [minSizes]="[0, 0, 0]">

            <!-- 1. GAUCHE : HISTORIQUE -->
            <ng-template pTemplate>
                <div class="panel sidebar-left">
                    <h3>Historique</h3>
                    <div class="scroll-container">
                        @for (item of appService.history(); track item) {
                        <div class="history-item" [class.active]="item === appService.currentSelection()"
                            (click)="appService.selectItem(item)">
                            <i class="pi pi-file" style="font-size: 1.2rem"></i>
                            <div class="item-info">
                                <span class="tool-tag">{{ item.tool_name }}</span>
                                <span class="date">{{ item.timestamp | date:'HH:mm:ss' }}</span>
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </ng-template>

            <!-- 2. CENTRE : CANVAS -->
            <ng-template pTemplate>
                <div class="panel center-canvas">
            
                    <!-- NOTRE NOUVEAU COMPOSANT INTELLIGENT -->
                    <!-- On lui passe l'historique complet pour la grille (items) -->
                    <!-- On lui passe l'√©tat de chargement -->
                    <app-smart-canvas [items]="appService.history()" [isLoading]="appService.isLoading()"
                        (selectItem)="appService.selectItem($event)">
                    </app-smart-canvas>


                    <!-- BARRE FLOTTANTE (Toujours visible maintenant) -->
                    <div class="command-bar-container">
                        <div class="floating-bar">
                            <input type="text" pInputText [(ngModel)]="userPrompt" (keydown.enter)="onGenerate()"
                                placeholder="D√©crivez votre figure... (ex: Triangle ABC rouge)"
                                [disabled]="appService.isLoading()">

                            <p-button icon="pi pi-arrow-right" [rounded]="true" [text]="true" (onClick)="onGenerate()"
                                [loading]="appService.isLoading()"></p-button>
                        </div>
                    </div>

                </div>
            </ng-template>

            <!-- 3. DROITE : INSPECTEUR -->
            <ng-template pTemplate>
                <div class="panel sidebar-right">
                    @if (appService.currentSelection(); as current) {
            
                    <!-- TAB VIEW (Les Onglets) -->
                    <p-tabView styleClass="h-full flex flex-col">
            
                        <!-- ONGLET 1 : CODE EDITOR (Prioritaire) -->
                        <p-tabPanel>
                            <ng-template pTemplate="header">
                                <div class="flex items-center gap-2">
                                    <i class="pi pi-code"></i>
                                    <span>LaTeX</span>
                                </div>
                            </ng-template>
            
                            <!-- Conteneur 100% Hauteur -->
                            <div class="h-full flex flex-col">
                                <app-code-editor [code]="current.latex_code" [isCompiling]="appService.isLoading()"
                                    (onRecompile)="onManualCompile($event)" (onRequestFix)="onFixWithAi($event)">
                                </app-code-editor>
                            </div>
                        </p-tabPanel>
            
                        <!-- ONGLET 2 : JSON (Secondaire) -->
                        <p-tabPanel>
                            <ng-template pTemplate="header">
                                <div class="flex items-center gap-2">
                                    <i class="pi pi-database"></i>
                                    <span>Donn√©es</span>
                                </div>
                            </ng-template>
            
                            <div class="json-viewer h-full overflow-auto p-4 bg-[#101010]">
                                <pre class="text-xs text-yellow-500 font-mono m-0">{{ current.json_content | json }}</pre>
                            </div>
                        </p-tabPanel>
            
                    </p-tabView>
            
                    } @else {
                    <div class="placeholder-center h-full flex items-center justify-center text-gray-600 italic">
                        <p>S√©lectionnez un objet</p>
                    </div>
                    }
                </div>
            </ng-template>

        </p-splitter>
    </div>
    
</div>