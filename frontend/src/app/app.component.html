<div class="flex flex-col h-screen w-screen bg-[#09090b] text-gray-200 overflow-hidden">

    <!-- HEADER -->
    <header class="h-12 flex-none flex items-center justify-between px-4 bg-[#18181b] border-b border-[#27272a] z-50">
        <div class="flex items-center gap-4">
            <button pButton (click)="toggleLeftPanel()" [text]="true" [rounded]="true"
                class="!w-8 !h-8 !p-0 !text-gray-400 hover:!text-white">
                <i [class]="isLeftVisible ? 'pi pi-align-justify' : 'pi pi-arrow-right'"></i>
            </button>
            <span class="font-bold text-lg">üìê Neuclid <span
                    class="text-xs bg-blue-900 px-1 rounded ml-1">v2.0</span></span>
        </div>
        <div class="flex items-center gap-4">
            <button pButton (click)="toggleRightPanel()" [text]="true" [rounded]="true"
                class="!w-8 !h-8 !p-0 !text-gray-400 hover:!text-white">
                <i [class]="isRightVisible ? 'pi pi-align-right' : 'pi pi-arrow-left'"></i>
            </button>
        </div>
    </header>

    <!-- WORKSPACE -->
    <div class="flex-1 w-full h-full relative overflow-hidden">

        <p-splitter [style]="{'height': '100%', 'border': 'none'}" [panelSizes]="panelSizes()" [minSizes]="[0, 0, 0]"
            [gutterSize]="4" (onResizeEnd)="onSplitterResize($event)"
            [styleClass]="(isLeftVisible ? '' : 'force-hide-left ') + (isRightVisible ? '' : ' force-hide-right')">

            <!-- GAUCHE -->
            <ng-template pTemplate>
                <div class="h-full w-full flex flex-col bg-[#18181b] border-r border-[#27272a]"
                    [style.display]="isLeftVisible ? 'flex' : 'none'">
                    <div class="p-3 text-xs font-bold text-gray-500 uppercase border-b border-[#27272a]">Historique
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">
                        @for (item of appService.history(); track item) {
                        <div class="p-2 mb-1 rounded hover:bg-white/5 cursor-pointer text-sm text-gray-300"
                            [class.bg-blue-900_40]="item === appService.currentSelection()"
                            (click)="appService.selectItem(item)">
                            {{ item.tool_name }} <span class="text-xs text-gray-500 float-right">{{ item.timestamp |
                                date:'HH:mm' }}</span>
                        </div>
                        }
                    </div>
                </div>
            </ng-template>

            <!-- CENTRE (CANVAS) -->
            <ng-template pTemplate>
                <div class="h-full w-full relative flex flex-col bg-[#09090b]">
                    <!-- CANVAS prend toute la place -->
                    <div class="flex-1 relative w-full h-full overflow-hidden">
                        <app-smart-canvas [items]="appService.history()"  [isLoading]="appService.isLoading()"
                            (selectItem)="appService.selectItem($event)">
                        </app-smart-canvas>
                    </div>

                    <!-- INPUT FLOTTANT -->
                    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 w-[600px] z-50">
                        <div
                            class="bg-[#18181b]/90 backdrop-blur border border-[#3f3f46] rounded-full p-1 pl-4 flex items-center shadow-2xl">
                            <input type="text" [(ngModel)]="userPrompt" (keydown.enter)="onGenerate()"
                                placeholder="D√©crivez votre figure..."
                                class="flex-1 bg-transparent border-none outline-none text-white h-10">
                            <button pButton icon="pi pi-arrow-up" (click)="onGenerate()" [rounded]="true"
                                class="ml-2"></button>
                        </div>
                    </div>
                </div>
            </ng-template>

            <!-- DROITE -->
            <ng-template pTemplate>
                <!-- Le conteneur Flex qui tient tout le panneau droit -->
                <div class="h-full w-full flex flex-col bg-[#18181b] border-l border-[#27272a]"
                    [style.display]="isRightVisible ? 'flex' : 'none'">
            
                    <!-- LE TABVIEW : On lui dit explicitement d'√™tre flexible -->
                    <p-tabView>
            
                        <!-- Onglet 1 : Code -->
                        <p-tabPanel header="Code" leftIcon="pi pi-code">
                            <app-code-editor *ngIf="appService.currentSelection() as curr"
                                [code]="curr.latex_code" class="block h-full w-full"> </app-code-editor>
                        </p-tabPanel>
            
                        <!-- Onglet 2 : Construction -->
                        <p-tabPanel>
                            <ng-template pTemplate="header">
                                <div class="flex items-center gap-2">
                                    <i class="pi pi-list"></i>
                                    <span>Construction</span>
                                </div>
                            </ng-template>
                        
                        
                            <app-construction-tree [data]="appService.currentSelection()?.json_content" class="block h-full w-full">
                            </app-construction-tree>
                        
                        </p-tabPanel>
            
                    </p-tabView>
                </div>
            </ng-template>

        </p-splitter>
    </div>
</div>